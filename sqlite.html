<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" type="text/css" href="style.css">
<link href="iThing.css" rel="stylesheet">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.css" />
</head>
<body>

<div class="grid grid-pad">
   <div class="col-2-3">
     <div class="module">
		<div id="slider"></div>
		<div id="map"></div>
		<!-- <div id="googft-mapCanvas"></div> -->
     </div>
   </div>
   <div class="col-1-3">
     <div class="module">
     	<div id="info"></div>	
     </div>
   </div>
</div>

<script src="jquery-ui-1.10.4.custom/js/jquery-1.10.2.js"></script>
<script src="jquery-ui-1.10.4.custom/js/jquery-ui-1.10.4.custom.js"></script>
<script src="jQDateRangeSlider-min.js"></script>
<script src="http://cdn.leafletjs.com/leaflet-0.7.2/leaflet.js"></script>
<!-- <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.2/handlebars.js"></script>
<script src="limabean.js"></script>

<script id="entry-template" type="text/x-handlebars-template">
  <div class="entry">
  {{#if latitude}}
	<h1>{{div_locality_id}} {{latitude}}</h1>
  {{else}}
	<h1>{{div_locality_id}} {{latitude}}</h1>
  {{/if}}
  </div>
</script>
	
<script type="text/javascript">
var udmap = udmap || {};
udmap.map = {};
udmap.info = {};

//handlebars style
udmap.info.style = {
	"color": "#ff7800",
	"weight": 5,
	"opacity": 0.65
};

//fires after DOM ready
$(function() {

udmap.map = L.map('map').setView([39.161944, -75.526667], 8);

//initialize jquery ui slider
$("#slider").dateRangeSlider({
    bounds: {min: new Date(2010,0), max: new Date(2014,4)},
    defaultValues: {min: new Date(2010,0), max: new Date(2014,4)},
	step:{months: 1},
	formatter:function(val){
        var days = val.getDate(),
          month = val.getMonth() + 1,
          year = val.getFullYear();
        return month + "/" + year;
      }
	});
		
//compiling handlebars
var source = $("#entry-template").html();
var template = Handlebars.compile(source);

function onEachFeature(feature, layer) {
	// add click handler to all features
	layer.on('click', function(e) {
		console.log(e.target);
		var html = template(e.target.feature.properties);
		$("#info").append(html);
	});
}

//local basemap tiles, currently generic world map
L.tileLayer('tiles/{z}/{x}/{y}.png', {
			minZoom: 5,
			maxZoom: 10,
			tms: true,
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://cloudmade.com">CloudMade</a>'
		}).addTo(udmap.map);


L.geoJson(locality, {
	style: udmap.info.style,
	onEachFeature: onEachFeature
}).addTo(udmap.map);

});

/* I really need to pin down overlay: what extent needs to draw, is "heat map" enough? or needs choropleth?  can make just one date instead of range?
if: choropleth then:cannot dynamically style polygons over the entire extent of the us (or is there someway to do this screen by screen??)
do sqlite query and extract only the geojson in view? style this dynamically
*** need php, send screen extent, do sqlite query, query records in table of (counties?? zips??) return geosjson, style */

/* default date range overlay
(this gets added to the fusion table layer object in gmaps) */

/* query: {
      select: 'geometry',
      from: '1EpUVocA4uVHzSOzbFrufyeNcVFu6ixxXNQPiH9dF'
      select: 'geometry, date',
      from: '1EpUVocA4uVHzSOzbFrufyeNcVFu6ixxXNQPiH9dF',
      where: 'date > \'03/2011\' and date < \'03/2013\''
    }, */


//need to add/bind a handler for the date range slider change, goes under init function

//add overlay based on date range	
/* function getLayer(layer,daterange){
	layer.setOptions({
        query: {
            select: columns,
            from: tableId,
            where: daterange
        },
		styleId: 2
    }); */
	
//and bind it (this does not need to be changed, though debugging code should be removed
/* $("#slider").bind("valuesChanged", function(e, data){
  console.log("Values just changed. min: " + data.values.min + " max: " + data.values.max);
  daterange = 'date > \'' + ("0" + (data.values.min.getMonth() + 1)).slice(-2) + '/' + data.values.min.getFullYear() + '\' and date < \'' + ("0" + (data.values.max.getMonth() + 1)).slice(-2) + '/' + data.values.max.getFullYear() + '\'';
  console.log(daterange);
  getLayer(layer,daterange);
}); */

</script>

</body>
</html>
